<div class="dashboard">
  <!-- Navigation Tabs -->
  <nav class="tab-nav">
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'rag'"
      (click)="setActiveTab('rag')">
      üîç RAG ({{ documents.length }})
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'chat'"
      (click)="setActiveTab('chat')">
      üí¨ Chat
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'vision'"
      (click)="setActiveTab('vision')">
      üëÅÔ∏è Vision
    </button>
  </nav>

  <!-- RAG Tab -->
  <div class="tab-content" *ngIf="activeTab === 'rag'">
    <div class="rag-layout">
      
      <!-- RAG Sidebar -->
      <aside class="rag-sidebar">
        <!-- File Upload Area -->
        <div class="upload-section">
          <div class="upload-area" 
               [class.drag-over]="dragOver"
               [class.uploading]="uploading"
               (dragover)="onDragOver($event)"
               (dragleave)="onDragLeave($event)"
               (drop)="onDrop($event)">
            
            <div class="upload-content" *ngIf="!uploading">
              <div class="upload-icon">üì§</div>
              <h4>Upload PDF</h4>
              <p>Drag & drop or click to select</p>
              <input 
                type="file" 
                accept="application/pdf" 
                (change)="onFileSelect($event)"
                #fileInput
                style="display: none">
              <button class="btn btn-primary btn-small" (click)="fileInput.click()">
                Choose File
              </button>
            </div>

            <div class="upload-progress" *ngIf="uploading">
              <div class="spinner"></div>
              <p>{{ uploadProgress }}</p>
            </div>
          </div>
        </div>

        <!-- Sessions List -->
        <div class="sessions-section">
          <div class="sidebar-header">
            <h3>RAG Sessions</h3>
            <button class="btn btn-small btn-primary" (click)="createNewSession()">
              + New
            </button>
          </div>

          <div class="sessions-list">
            <div 
              class="session-item"
              *ngFor="let session of sessions"
              [class.active]="currentSession?.id === session.id"
              (click)="selectSession(session)">
              <div class="session-title">{{ session.title }}</div>
              <div class="session-date">{{ session.createdAt.toLocaleDateString() }}</div>
            </div>
          </div>
        </div>

        <!-- Documents List -->
        <div class="documents-section">
          <h4>Your Documents ({{ documents.length }})</h4>
          
          <div class="document-list" *ngIf="documents.length > 0">
            <div 
              class="document-item" 
              *ngFor="let doc of documents"
              [class.selected]="selectedDocument?.id === doc.id"
              [class.processing]="doc.status === 'processing'"
              [class.error]="doc.status === 'error'"
              (click)="selectDocument(doc)">
              
              <div class="doc-icon">
                <span *ngIf="doc.status === 'completed'">üìÑ</span>
                <span *ngIf="doc.status === 'processing'" class="processing-icon">‚è≥</span>
                <span *ngIf="doc.status === 'error'">‚ùå</span>
              </div>
              
              <div class="doc-info">
                <div class="doc-name">{{ doc.filename }}</div>
                <div class="doc-status" [class]="doc.status">{{ doc.status }}</div>
              </div>
            </div>
          </div>

          <div class="empty-docs" *ngIf="documents.length === 0 && !uploading">
            <p>No documents yet</p>
          </div>
        </div>

        <!-- Document Filter -->
        <div class="document-filter" *ngIf="documents.length > 0">
          <h4>Filter by Document</h4>
          <select class="doc-select" [(ngModel)]="selectedDocument">
            <option [ngValue]="null">All documents</option>
            <option 
              *ngFor="let doc of documents" 
              [ngValue]="doc"
              [disabled]="doc.status !== 'completed'">
              {{ doc.filename }}
            </option>
          </select>
        </div>
      </aside>

      <!-- RAG Chat Main -->
      <main class="rag-main">
        <div class="chat-header" *ngIf="currentSession">
          <h2>{{ currentSession.title }}</h2>
          <div class="chat-info" *ngIf="selectedDocument">
            <span class="document-badge">üìÑ {{ selectedDocument.filename }}</span>
          </div>
        </div>

        <div class="messages-container" *ngIf="currentSession">
          <div class="messages-list">
            <div 
              class="message"
              *ngFor="let message of messages"
              [class.user-message]="message.role === 'user'"
              [class.assistant-message]="message.role === 'assistant'">
              
              <div class="message-content">
                <div class="message-text">{{ message.content }}</div>
                <div class="message-sources" *ngIf="message.sources && message.sources.length > 0">
                  <h5>Sources:</h5>
                  <div class="source-tags">
                    <span 
                      class="source-tag" 
                      *ngFor="let source of message.sources">
                      {{ source.label }}
                    </span>
                  </div>
                </div>
              </div>
              
              <div class="message-time">
                {{ message.createdAt.toLocaleTimeString() }}
              </div>
            </div>

            <div class="message assistant-message" *ngIf="sending">
              <div class="message-content">
                <div class="typing-indicator">
                  <span></span><span></span><span></span>
                </div>
              </div>
            </div>
          </div>

          <div class="message-input-area">
            <div class="input-wrapper">
              <textarea 
                class="message-input"
                [(ngModel)]="messageInput"
                (keydown)="onEnterKey($event)"
                placeholder="Ask a question about your documents..."
                rows="2"
                [disabled]="sending || documents.length === 0"></textarea>
              <button 
                class="send-btn"
                (click)="sendMessage()"
                [disabled]="!messageInput.trim() || sending || documents.length === 0">
                <span *ngIf="!sending">‚û§</span>
                <span *ngIf="sending" class="sending-icon">‚è≥</span>
              </button>
            </div>
            <div class="input-help" *ngIf="documents.length === 0">
              Upload some documents first to start chatting!
            </div>
          </div>
        </div>

        <div class="empty-chat" *ngIf="!currentSession">
          <h3>Welcome to RAG Chat! ü§ñ</h3>
          <p>Create a new chat session to start asking questions about your documents.</p>
          <button class="btn btn-primary" (click)="createNewSession()">
            Start New RAG Session
          </button>
        </div>
      </main>
    </div>
  </div>

  <!-- Chat Tab -->
  <div class="tab-content" *ngIf="activeTab === 'chat'">
    <div class="general-chat-container">
      <div class="general-chat-header">
        <h3>üí¨ General Chat</h3>
        <p>Ask any question - no documents required!</p>
      </div>

      <div class="messages-container">
        <div class="messages-list">
          <div 
            class="message"
            *ngFor="let message of generalMessages"
            [class.user-message]="message.role === 'user'"
            [class.assistant-message]="message.role === 'assistant'">
            
            <div class="message-content">
              <div class="message-text">{{ message.content }}</div>
            </div>
            
            <div class="message-time">
              {{ message.createdAt.toLocaleTimeString() }}
            </div>
          </div>

          <div class="message assistant-message" *ngIf="sendingGeneral">
            <div class="message-content">
              <div class="typing-indicator">
                <span></span><span></span><span></span>
              </div>
            </div>
          </div>
        </div>

        <div class="message-input-area">
          <div class="input-wrapper">
            <textarea 
              class="message-input"
              [(ngModel)]="generalMessageInput"
              (keydown)="onGeneralEnterKey($event)"
              placeholder="Ask me anything..."
              rows="2"
              [disabled]="sendingGeneral"></textarea>
            <button 
              class="send-btn"
              (click)="sendGeneralMessage()"
              [disabled]="!generalMessageInput.trim() || sendingGeneral">
              <span *ngIf="!sendingGeneral">‚û§</span>
              <span *ngIf="sendingGeneral" class="sending-icon">‚è≥</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vision Tab -->
  <div class="tab-content" *ngIf="activeTab === 'vision'">
    <div class="vision-container">
      <div class="vision-header">
        <h3>üëÅÔ∏è Vision Analysis</h3>
        <p>Upload an image and let AI analyze it for you!</p>
      </div>

      <div class="vision-content">
        <!-- Image Upload Section -->
        <div class="vision-upload-section">
          <div class="image-upload-area" 
               [class.drag-over]="visionDragOver"
               [class.uploading]="visionUploading"
               [class.has-image]="selectedImage"
               (dragover)="onVisionDragOver($event)"
               (dragleave)="onVisionDragLeave($event)"
               (drop)="onVisionDrop($event)">
            
            <div class="upload-content" *ngIf="!selectedImage && !visionUploading">
              <div class="upload-icon">üñºÔ∏è</div>
              <h4>Upload Image</h4>
              <p>Drag & drop or click to select</p>
              <p class="supported-formats">Supports: JPG, PNG, GIF, WebP</p>
              <input 
                type="file" 
                accept="image/*" 
                (change)="onImageSelect($event)"
                #imageInput
                style="display: none">
              <button class="btn btn-primary btn-small" (click)="imageInput.click()">
                Choose Image
              </button>
            </div>

            <div class="image-preview" *ngIf="selectedImage && !visionUploading">
              <img [src]="selectedImage.url" [alt]="selectedImage.name" class="preview-image">
              <div class="image-info">
                <div class="image-name">{{ selectedImage.name }}</div>
                <div class="image-size">{{ formatFileSize(selectedImage.size) }}</div>
              </div>
              <button class="btn btn-small btn-secondary" (click)="clearSelectedImage()">
                Remove
              </button>
            </div>

            <div class="upload-progress" *ngIf="visionUploading">
              <div class="spinner"></div>
              <p>Processing image...</p>
            </div>
          </div>

          <div class="vision-input-area" *ngIf="selectedImage && !visionUploading">
            <textarea 
              class="vision-prompt-input"
              [(ngModel)]="visionPrompt"
              placeholder="What would you like to know about this image? (Optional - leave blank for general analysis)"
              rows="3"></textarea>
            <button 
              class="btn btn-primary"
              (click)="analyzeImage()"
              [disabled]="sendingVision || !selectedImage">
              <span *ngIf="!sendingVision">Analyze Image</span>
              <span *ngIf="sendingVision">Analyzing...</span>
            </button>
          </div>
        </div>

        <!-- Vision Results Section -->
        <div class="vision-results" *ngIf="visionMessages.length > 0">
          <h4>Analysis Results</h4>
          <div class="vision-messages">
            <div 
              class="vision-message"
              *ngFor="let message of visionMessages; let i = index"
              [class.user-message]="message.role === 'user'"
              [class.assistant-message]="message.role === 'assistant'">
              
              <div class="message-content">
                <div class="message-image" *ngIf="message.image">
                  <img [src]="message.image.url" [alt]="message.image.name" class="message-image-preview">
                </div>
                <div class="message-text" *ngIf="message.content">{{ message.content }}</div>
                <div class="message-prompt" *ngIf="message.prompt">
                  <strong>Prompt:</strong> {{ message.prompt }}
                </div>
              </div>
              
              <div class="message-time">
                {{ message.createdAt.toLocaleTimeString() }}
              </div>
            </div>

            <div class="vision-message assistant-message" *ngIf="sendingVision">
              <div class="message-content">
                <div class="typing-indicator">
                  <span></span><span></span><span></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>