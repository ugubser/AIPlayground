<div class="dashboard">
  <!-- Navigation Tabs -->
  <nav class="tab-nav">
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'rag'"
      (click)="setActiveTab('rag')">
      üîç RAG (Retrieval-Augmented Generation) ({{ documents.length }})
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'chat'"
      (click)="setActiveTab('chat')">
      üí¨ Chat & MCP (Model Context Protocol)
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'vision'"
      (click)="setActiveTab('vision')">
      üëÅÔ∏è Vision
    </button>
  </nav>

  <!-- RAG Tab -->
  <div class="tab-content" *ngIf="activeTab === 'rag'">
    <div class="rag-layout">
      
      <!-- RAG Sidebar -->
      <aside class="rag-sidebar">
        <!-- File Upload Area -->
        <div class="upload-section">
          <div class="upload-area" 
               [class.drag-over]="dragOver"
               [class.uploading]="uploading"
               [class.disabled]="!currentSession"
               (dragover)="currentSession ? onDragOver($event) : null"
               (dragleave)="currentSession ? onDragLeave($event) : null"
               (drop)="currentSession ? onDrop($event) : null">
            
            <div class="upload-content" *ngIf="!uploading">
              <div class="upload-icon">üì§</div>
              <h4>Upload PDF</h4>
              <p *ngIf="currentSession">Drag & drop or click to select</p>
              <p *ngIf="!currentSession" class="disabled-text">Create a session first to upload documents</p>
              <input 
                type="file" 
                accept="application/pdf" 
                (change)="onFileSelect($event)"
                #fileInput
                style="display: none"
                [disabled]="!currentSession">
              <button 
                class="btn btn-primary btn-small" 
                (click)="currentSession ? fileInput.click() : null"
                [disabled]="!currentSession">
                Choose File
              </button>
            </div>

            <div class="upload-progress" *ngIf="uploading">
              <div class="spinner"></div>
              <p>{{ uploadProgress }}</p>
            </div>
          </div>
        </div>

        <!-- Sessions List -->
        <div class="sessions-section">
          <div class="sidebar-header">
            <h3>RAG Sessions</h3>
            <button class="btn btn-small btn-primary" (click)="createNewSession()">
              + New
            </button>
          </div>

          <div class="sessions-list">
            <div 
              class="session-item"
              *ngFor="let session of sessions"
              [class.active]="currentSession?.id === session.id"
              (click)="selectSession(session)">
              <div class="session-content">
                <div class="session-title">{{ session.title }}</div>
                <div class="session-date">{{ session.createdAt.toLocaleDateString() }} {{ session.createdAt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) }}</div>
              </div>
              <div class="session-actions">
                <button 
                  class="btn btn-small btn-danger session-delete-btn" 
                  (click)="deleteSession(session); $event.stopPropagation()"
                  [disabled]="deletingSession === session.id"
                  title="Delete session">
                  <span *ngIf="deletingSession !== session.id">üóëÔ∏è</span>
                  <span *ngIf="deletingSession === session.id">‚è≥</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Documents List -->
        <div class="documents-section">
          <h4>Session Documents ({{ getSessionDocuments().length }})</h4>
          
          <div class="document-list" *ngIf="getSessionDocuments().length > 0">
            <div 
              class="document-item" 
              *ngFor="let doc of getSessionDocuments()"
              [class.selected]="selectedDocument?.id === doc.id"
              [class.processing]="doc.status === 'processing'"
              [class.error]="doc.status === 'error'"
              [class.compatible]="isDocumentCompatible(doc)"
              [class.incompatible]="!isDocumentCompatible(doc)"
              (click)="selectDocument(doc)">
              
              <div class="doc-icon">
                <span *ngIf="doc.status === 'completed'">üìÑ</span>
                <span *ngIf="doc.status === 'processing'" class="processing-icon">‚è≥</span>
                <span *ngIf="doc.status === 'error'">‚ùå</span>
              </div>
              
              <div class="doc-info">
                <div class="doc-name">{{ doc.filename }}</div>
                <div class="doc-status" [class]="doc.status">{{ doc.status }}</div>
                <div class="doc-model" *ngIf="doc.embedModel">
                  <small>{{ doc.embedModel.provider }}/{{ doc.embedModel.model }}</small>
                  <span class="compatibility-indicator" *ngIf="!isDocumentCompatible(doc)" title="Incompatible embedding model">‚ö†Ô∏è</span>
                  <span class="compatibility-indicator" *ngIf="isDocumentCompatible(doc)" title="Compatible embedding model">‚úÖ</span>
                </div>
              </div>
              
              <div class="doc-actions">
                <button 
                  class="btn btn-small btn-danger" 
                  (click)="deleteDocument(doc); $event.stopPropagation()"
                  [disabled]="deleting === doc.id"
                  title="Delete document">
                  <span *ngIf="deleting !== doc.id">üóëÔ∏è</span>
                  <span *ngIf="deleting === doc.id">‚è≥</span>
                </button>
              </div>
            </div>
          </div>

          <div class="empty-docs" *ngIf="getSessionDocuments().length === 0 && !uploading && currentSession">
            <p>No documents in this session yet</p>
            <p><small>Upload a document above to get started</small></p>
          </div>
          
          <div class="empty-docs" *ngIf="!currentSession">
            <p>No session selected</p>
            <p><small>Create or select a session first</small></p>
          </div>
        </div>

        <!-- Document Filter -->
        <div class="document-filter" *ngIf="getSessionDocuments().length > 0">
          <h4>Filter by Document</h4>
          <select class="doc-select" [(ngModel)]="selectedDocument">
            <option [ngValue]="null">All session documents</option>
            <option 
              *ngFor="let doc of getSessionDocuments()" 
              [ngValue]="doc"
              [disabled]="doc.status !== 'completed'">
              {{ doc.filename }}
              <span *ngIf="!isDocumentCompatible(doc)"> (‚ö†Ô∏è incompatible)</span>
            </option>
          </select>
        </div>
      </aside>

      <!-- RAG Chat Main -->
      <main class="rag-main">
        <div class="chat-header" *ngIf="currentSession">
          <h2>{{ currentSession.title }}</h2>
          <div class="session-info">
            <div class="session-documents" *ngIf="currentSession.associatedDocuments && currentSession.associatedDocuments.length > 0">
              <h4>Active in this Session:</h4>
              <div class="session-doc-list">
                <span 
                  *ngFor="let docId of currentSession.associatedDocuments; let i = index" 
                  class="session-doc-badge"
                  [class.incompatible-badge]="!isDocumentByIdCompatible(docId)">
                  üìÑ {{ getDocumentName(docId) }}
                  <span *ngIf="!isDocumentByIdCompatible(docId)" class="incompatible-warning" title="Incompatible embedding model">‚ö†Ô∏è</span>
                  <button 
                    class="remove-doc-btn" 
                    (click)="removeDocumentFromCurrentSession(docId)"
                    title="Remove from session">√ó</button>
                </span>
              </div>
            </div>
            <div class="add-documents-section">
              <button 
                class="btn btn-small btn-secondary" 
                (click)="showAddDocuments = !showAddDocuments">
                {{ showAddDocuments ? 'Hide' : 'Add' }} Documents to Session
              </button>
              <div class="add-documents-list" *ngIf="showAddDocuments">
                <div 
                  *ngFor="let doc of getAvailableDocuments()" 
                  class="add-doc-item"
                  (click)="addDocumentToCurrentSession(doc.id!)">
                  <span class="doc-name">{{ doc.filename }}</span>
                  <span class="add-doc-btn">+</span>
                </div>
              </div>
            </div>
            <div class="chat-info" *ngIf="selectedDocument">
              <span class="document-badge">üìÑ {{ selectedDocument.filename }}</span>
            </div>
          </div>
        </div>

        <div class="messages-container" *ngIf="currentSession">
          <div class="messages-list" #ragMessagesContainer>
            <ng-container *ngFor="let message of messages; let i = index">
              <div 
                class="message"
                [class.user-message]="message.role === 'user'"
                [class.assistant-message]="message.role === 'assistant'">
                
                <div class="message-content">
                  <div class="message-text">
                    <markdown [data]="message.content"></markdown>
                  </div>
                  <div class="message-sources" *ngIf="message.sources && message.sources.length > 0">
                    <h5>Sources:</h5>
                    <div class="source-tags">
                      <span 
                        class="source-tag" 
                        *ngFor="let source of message.sources">
                        {{ source.label }}
                      </span>
                    </div>
                  </div>
                </div>
                
                <div class="message-time">
                  {{ message.createdAt.toLocaleTimeString() }}
                </div>
              </div>

              <!-- Show prompt logs after assistant messages -->
              <ng-container *ngIf="message.role === 'assistant' && message.id">
                <app-prompt-message 
                  *ngFor="let promptLog of getPromptLogsForMessage(message.id); trackBy: trackByPromptId"
                  [entry]="promptLog">
                </app-prompt-message>
              </ng-container>
            </ng-container>

            <div class="message assistant-message" *ngIf="sending">
              <div class="message-content">
                <div class="typing-indicator">
                  <span></span><span></span><span></span>
                </div>
              </div>
            </div>
          </div>

          <div class="message-input-area">
            <div class="input-wrapper">
              <textarea 
                class="message-input"
                [(ngModel)]="messageInput"
                (keydown)="onEnterKey($event)"
                placeholder="Ask a question about your documents..."
                rows="2"
                [disabled]="sending || documents.length === 0"></textarea>
              <button 
                class="send-btn"
                (click)="sendMessage()"
                [disabled]="!messageInput.trim() || sending || documents.length === 0">
                <span *ngIf="!sending">‚û§</span>
                <span *ngIf="sending" class="sending-icon">‚è≥</span>
              </button>
            </div>
            <div class="input-help" *ngIf="documents.length === 0">
              Upload some documents first to start chatting!
            </div>
          </div>
        </div>

        <div class="empty-chat" *ngIf="!currentSession">
          <h3>Welcome to RAG Chat! ü§ñ</h3>
          <p>Create a new chat session to start asking questions about your documents.</p>
          <button class="btn btn-primary" (click)="createNewSession()">
            Start New RAG Session
          </button>
        </div>
      </main>
    </div>
  </div>

  <!-- Chat Tab -->
  <div class="tab-content" *ngIf="activeTab === 'chat'">
    <div class="chat-layout">
      <div class="chat-sidebar">
        <div class="sidebar-header">
          <h3>üí¨ Chat Settings</h3>
        </div>
        
        <div class="mcp-settings">
          <label class="mcp-checkbox">
            <input 
              type="checkbox" 
              [(ngModel)]="mcpEnabled"
              (change)="onMcpToggle()">
            <span class="checkmark"></span>
            Enable MCP (Tool Calling)
          </label>
          
          <label class="mcp-checkbox" *ngIf="mcpEnabled">
            <input
              type="checkbox"
              [(ngModel)]="multiAgentEnabled"
              (change)="onMultiAgentToggle()">
            <span class="checkmark"></span>
            Multi-Agent Orchestration (Beta)
          </label>

          <label class="mcp-checkbox" *ngIf="mcpEnabled && multiAgentEnabled">
            <input
              type="checkbox"
              [(ngModel)]="skipCriticPhase">
            <span class="checkmark"></span>
            Skip Critic Phase (End at Verifier)
          </label>

          <div class="mcp-servers" *ngIf="mcpEnabled">
            <h4>MCP Servers ({{ getTotalEnabledTools() }} tools):</h4>
            <div class="server-list-compact">
              <label 
                class="server-item-compact" 
                *ngFor="let server of mcpServers"
                [title]="server.description + (server.tools ? ' ‚Ä¢ ' + server.tools.length + ' tools: ' + getToolNames(server.tools) : '')">
                <input 
                  type="checkbox" 
                  [checked]="server.enabled"
                  (change)="onServerToggle(server.id, $event)">
                <span class="server-name">{{ server.name }}</span>
                <span class="server-status-icon" [class]="'status-' + server.status">
                  {{ getStatusIcon(server.status) }}
                </span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="chat-main">
        <div class="chat-header">
          <h2>General Chat</h2>
        </div>

      <div class="messages-container">
        <div class="messages-list" #generalMessagesContainer>
          <ng-container *ngFor="let entry of generalTimeline; trackBy: trackTimelineEntry">
            <ng-container [ngSwitch]="entry.kind">
              <div 
                *ngSwitchCase="'message'"
                class="message"
                [class.user-message]="entry.message!.role === 'user'"
                [class.assistant-message]="entry.message!.role === 'assistant'">
                <div class="message-content">
                  <div class="message-text">
                    <markdown [data]="entry.message!.content"></markdown>
                  </div>
                </div>
                <div class="message-time">
                  {{ entry.message!.createdAt.toLocaleTimeString() }}
                </div>
              </div>

              <app-prompt-message
                *ngSwitchCase="'prompt'"
                [entry]="entry.prompt!">
              </app-prompt-message>
            </ng-container>
          </ng-container>

          <div class="message assistant-message" *ngIf="sendingGeneral">
            <div class="message-content">
              <div class="typing-indicator">
                <span></span><span></span><span></span>
              </div>
            </div>
          </div>
        </div>

        <div class="message-input-area">
          <div class="input-wrapper">
            <textarea 
              class="message-input"
              [(ngModel)]="generalMessageInput"
              (keydown)="onGeneralEnterKey($event)"
              placeholder="Ask me anything..."
              rows="2"
              [disabled]="sendingGeneral"></textarea>
            <button 
              class="send-btn"
              (click)="sendGeneralMessage()"
              [disabled]="!generalMessageInput.trim() || sendingGeneral">
              <span *ngIf="!sendingGeneral">‚û§</span>
              <span *ngIf="sendingGeneral" class="sending-icon">‚è≥</span>
            </button>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>

  <!-- Vision Tab -->
  <div class="tab-content" *ngIf="activeTab === 'vision'">
    <div class="vision-layout">
      <div class="vision-sidebar">
        <div class="sidebar-header">
          <h3>üëÅÔ∏è Image Upload</h3>
        </div>
        
        <!-- Image Upload Section -->
        <div class="vision-upload-section">
          <div class="image-upload-area" 
               [class.drag-over]="visionDragOver"
               [class.uploading]="visionUploading"
               [class.has-image]="selectedImage"
               (dragover)="onVisionDragOver($event)"
               (dragleave)="onVisionDragLeave($event)"
               (drop)="onVisionDrop($event)">
            
            <div class="upload-content" *ngIf="!selectedImage && !visionUploading">
              <div class="upload-icon">üñºÔ∏è</div>
              <h4>Upload Image</h4>
              <p>Drag & drop or click to select</p>
              <p class="supported-formats">Supports: JPG, PNG, GIF, WebP</p>
              <input 
                type="file" 
                accept="image/*" 
                (change)="onImageSelect($event)"
                #imageInput
                style="display: none">
              <button class="btn btn-primary btn-small" (click)="imageInput.click()">
                Choose Image
              </button>
            </div>

            <div class="image-preview" *ngIf="selectedImage && !visionUploading">
              <img [src]="selectedImage.url" [alt]="selectedImage.name" class="preview-image">
              <div class="image-info">
                <div class="image-name">{{ selectedImage.name }}</div>
                <div class="image-size">{{ formatFileSize(selectedImage.size) }}</div>
              </div>
              <button class="btn btn-small btn-secondary" (click)="clearSelectedImage()">
                Remove
              </button>
            </div>

            <div class="upload-progress" *ngIf="visionUploading">
              <div class="spinner"></div>
              <p>Processing image...</p>
            </div>
          </div>

          <div class="vision-input-area" *ngIf="selectedImage && !visionUploading">
            <textarea 
              class="vision-prompt-input"
              [(ngModel)]="visionPrompt"
              placeholder="What would you like to know about this image? (Optional - leave blank for general analysis)"
              rows="3"></textarea>
            <button 
              class="btn btn-primary"
              (click)="analyzeImage()"
              [disabled]="sendingVision || !selectedImage">
              <span *ngIf="!sendingVision">Analyze Image</span>
              <span *ngIf="sendingVision">Analyzing...</span>
            </button>
          </div>
        </div>
      </div>

      <div class="vision-main">
        <div class="chat-header">
          <h2>Vision Analysis</h2>
        </div>

        <!-- Vision Results Section -->
        <div class="vision-results" *ngIf="visionMessages.length > 0">
          <h4>Analysis Results</h4>
          <div class="vision-messages" #visionMessagesContainer>
            <ng-container *ngFor="let message of visionMessages; let i = index">
              <div 
                class="vision-message"
                [class.user-message]="message.role === 'user'"
                [class.assistant-message]="message.role === 'assistant'">
                
                <div class="message-content">
                  <div class="message-image" *ngIf="message.image">
                    <img [src]="message.image.url" [alt]="message.image.name" class="message-image-preview">
                  </div>
                  <div class="message-text" *ngIf="message.content">
                    <markdown [data]="message.content"></markdown>
                  </div>
                  <div class="message-prompt" *ngIf="message.prompt">
                    <strong>Prompt:</strong> {{ message.prompt }}
                  </div>
                </div>
                
                <div class="message-time">
                  {{ message.createdAt.toLocaleTimeString() }}
                </div>
              </div>

              <!-- Show prompt logs after assistant messages -->
              <ng-container *ngIf="message.role === 'assistant' && message.id">
                <app-prompt-message 
                  *ngFor="let promptLog of getPromptLogsForMessage(message.id); trackBy: trackByPromptId"
                  [entry]="promptLog">
                </app-prompt-message>
              </ng-container>
            </ng-container>

            <div class="vision-message assistant-message" *ngIf="sendingVision">
              <div class="message-content">
                <div class="typing-indicator">
                  <span></span><span></span><span></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="empty-chat" *ngIf="visionMessages.length === 0">
          <h3>Upload an image to get started! üì∏</h3>
          <p>Select an image from the sidebar and ask questions about it.</p>
        </div>
      </div>
    </div>
  </div>
</div>
